{% extends 'qrcode_generator/base.html' %}
{% load static %}

{% block title %}Gerador de QR Code - Intranet{% endblock %}

{% block extra_css %}
    <link href="{% static 'qrcode_generator/css/index_styles.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Header -->
        <div class="text-center mb-5 fade-in">
            <div class="feature-icon mx-auto mb-3">
                <i class="fas fa-qrcode"></i>
            </div>
            <h1 class="display-5 fw-bold mb-3">Gerador de QR Code</h1>
        </div>

        <!-- QR Code Generator Form -->
        <div class="card slide-in">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>Gerar Novo QR Code
                </h5>
            </div>
            <div class="card-body">
                <form id="qrForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="qrType" class="form-label">
                                <i class="fas fa-tag me-1"></i>Tipo de QR Code
                            </label>
                            <select class="form-select" id="qrType" name="type" required>
                                <option value="text">Texto Simples</option>
                                <option value="url">URL/Link</option>
                                <option value="email">Email</option>
                                <option value="phone">Telefone</option>
                                <option value="sms">SMS</option>
                                <option value="wifi">WiFi</option>
                                <option value="vcard">vCard (Contato)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="qrSize" class="form-label">
                                <i class="fas fa-expand-arrows-alt me-1"></i>Tamanho
                            </label>
                            <select class="form-select" id="qrSize" name="size">
                                <option value="8">Pequeno (8px)</option>
                                <option value="10" selected>Médio (10px)</option>
                                <option value="12">Grande (12px)</option>
                                <option value="15">Extra Grande (15px)</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="qrContent" class="form-label">
                            <i class="fas fa-edit me-1"></i>Conteúdo
                        </label>
                        <textarea class="form-control" id="qrContent" name="content" rows="4" 
                                  placeholder="Digite o conteúdo do seu QR Code..." required></textarea>
                        <div class="form-text" id="contentHelp">
                            Digite o texto, URL, email ou informação que deseja codificar no QR Code.
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="qrBorder" class="form-label">
                                <i class="fas fa-border-style me-1"></i>Borda
                            </label>
                            <select class="form-select" id="qrBorder" name="border">
                                <option value="2">Fina (2px)</option>
                                <option value="4" selected>Normal (4px)</option>
                                <option value="6">Grossa (6px)</option>
                                <option value="8">Extra Grossa (8px)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100" id="generateBtn">
                                <i class="fas fa-magic me-2"></i>Gerar QR Code
                                <div class="spinner-border spinner-border-sm ms-2 loading-spinner" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Alert Messages -->
                <div id="alertContainer"></div>

                <!-- QR Code Result -->
                <div id="qrResult" class="qr-result">
                    <h5 class="mb-3">
                        <i class="fas fa-check-circle text-success me-2"></i>QR Code Gerado com Sucesso!
                    </h5>
                    <div class="mb-3">
                        <img id="qrImage" src="" alt="QR Code" class="qr-image">
                    </div>
                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                        <button type="button" class="btn btn-outline-primary" id="downloadBtn">
                            <i class="fas fa-download me-2"></i>Download PNG
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="newQrBtn">
                            <i class="fas fa-plus me-2"></i>Gerar Novo
                        </button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Conteúdo: <span id="qrContentDisplay"></span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="row mt-5">
            <div class="col-md-4 mb-4">
                <div class="card h-100 text-center">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h5 class="card-title">Seguro</h5>
                        <p class="card-text">
                            Todos os QR Codes são gerados localmente na sua intranet, 
                            garantindo a segurança dos seus dados.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100 text-center">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <h5 class="card-title">Rápido</h5>
                        <p class="card-text">
                            Geração instantânea de QR Codes com interface otimizada 
                            para máxima produtividade.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100 text-center">
                    <div class="card-body">
                        <div class="feature-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <h5 class="card-title">Responsivo</h5>
                        <p class="card-text">
                            Interface adaptável que funciona perfeitamente em 
                            dispositivos móveis, tablets e desktops.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("qrForm");
    const generateBtn = document.getElementById("generateBtn");
    const loadingSpinner = document.querySelector(".loading-spinner");
    const alertContainer = document.getElementById("alertContainer");
    const qrResult = document.getElementById("qrResult");
    const qrImage = document.getElementById("qrImage");
    const qrContentDisplay = document.getElementById("qrContentDisplay");
    const downloadBtn = document.getElementById("downloadBtn");
    const newQrBtn = document.getElementById("newQrBtn");
    const qrType = document.getElementById("qrType");
    const qrContent = document.getElementById("qrContent");
    const contentHelp = document.getElementById("contentHelp");

    // Atualiza placeholder e ajuda baseado no tipo
    qrType.addEventListener("change", function() {
        const type = this.value;
        let placeholder = "";
        let help = "";

        switch(type) {
            case "text":
                placeholder = "Digite seu texto aqui...";
                help = "Digite qualquer texto que deseja codificar no QR Code.";
                break;
            case "url":
                placeholder = "https://www.exemplo.com.br";
                help = "Digite a URL completa (com http:// ou https://).";
                break;
            case "email":
                placeholder = "usuario@empresa.com.br";
                help = "Digite o endereço de email.";
                break;
            case "phone":
                placeholder = "+55 11 99999-9999";
                help = "Digite o número de telefone com código do país.";
                break;
            case "sms":
                placeholder = "+55 11 99999-9999";
                help = "Digite o número para envio de SMS.";
                break;
            case "wifi":
                placeholder = "SSID:senha:tipo (ex: MinhaRede:123456:WPA)";
                help = "Formato: Nome_da_Rede:Senha:Tipo_de_Segurança (WPA/WEP/nopass)";
                break;
            case "vcard":
                placeholder = "Nome:Empresa:Telefone:Email";
                help = "Formato: João Silva:Empresa LTDA:+55 11 99999-9999:joao@empresa.com";
                break;
        }

        qrContent.placeholder = placeholder;
        contentHelp.textContent = help;
    });

    // Submissão do formulário
    form.addEventListener("submit", function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {
            content: formData.get("content"),
            type: formData.get("type"),
            size: formData.get("size"),
            border: formData.get("border")
        };

        // Mostra loading
        generateBtn.disabled = true;
        loadingSpinner.classList.add("show");
        hideAlert();
        qrResult.classList.remove("show");

        // Faz requisição
        fetch("{% url "qrcode_generator:generate" %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                qrImage.src = data.image;
                qrContentDisplay.textContent = data.content;
                qrResult.classList.add("show");
                showAlert("QR Code gerado com sucesso!", "success");
            } else {
                showAlert(data.error || "Erro ao gerar QR Code", "danger");
            }
        })
        .catch(error => {
            console.error("Erro:", error);
            showAlert("Erro de conexão. Tente novamente.", "danger");
        })
        .finally(() => {
            generateBtn.disabled = false;
            loadingSpinner.classList.remove("show");
        });
    });

    // Download do QR Code
    downloadBtn.addEventListener("click", function() {
        const data = {
            content: qrContentDisplay.textContent,
            size: document.getElementById("qrSize").value,
            border: document.getElementById("qrBorder").value
        };

        fetch("{% url "qrcode_generator:download" %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(data)
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "qrcode.png";
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        })
        .catch(error => {
            console.error("Erro no download:", error);
            showAlert("Erro ao fazer download. Tente novamente.", "danger");
        });
    });

    // Gerar novo QR Code
    newQrBtn.addEventListener("click", function() {
        form.reset();
        qrResult.classList.remove("show");
        hideAlert();
        qrContent.focus();
    });

    // Funções auxiliares
    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${type === "success" ? "check-circle" : "exclamation-triangle"} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        alertContainer.innerHTML = alertHtml;
    }

    function hideAlert() {
        alertContainer.innerHTML = "";
    }
});
</script>
{% endblock %}



